{% extends 'base.html' %}
{% load static %}

{% block title %}Nkadime â€“ FTCT Deposits{% endblock %}

{% block content %}
<div class="shell">
  <div class="card" id="card-overview">
    <div class="heading">
      <h1>Nkadime FTCT Liquidity Pool</h1>
      <p>Deposit FTCT to earn a share of pool interest.</p>
    </div>
    <div class="metrics" id="metrics">
      <div class="metric">
        <div class="label">Total Pool</div>
        <div class="value" id="m-total-pool"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:120px;"></span></div>
      </div>
      <div class="metric">
        <div class="label">Total Shares</div>
        <div class="value" id="m-total-shares"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:140px;"></span></div>
      </div>
      <div class="metric">
        <div class="label">Active Loans</div>
        <div class="value" id="m-active-loans"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:60px;"></span></div>
      </div>
      <div class="metric">
        <div class="label">Your Investment (est.)</div>
        <div class="value" id="m-user-value"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:120px;"></span></div>
      </div>
      <div class="metric">
        <div class="label">Your Shares</div>
        <div class="value" id="m-user-shares"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:120px;"></span></div>
      </div>
      <div class="metric">
        <div class="label">Your PnL</div>
        <div class="value" id="m-user-pnl"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:120px;"></span></div>
      </div>
    </div>
    <div class="note">These wallet details were prefilled from your Telegram account and can be edited below.</div>
    <hr class="hr" />
    <form method="post" id="depositForm">
      {% csrf_token %}
      <input type="hidden" name="code" value="{{ code }}" />
      <div class="field">
        <label>Wallet Address</label>
        <input type="text" name="wallet" placeholder="0x..." value="{{ wallet_q }}" required />
      </div>
      <div class="field field-with-hidden">
        <label>Private Key</label>
        {% if private_key_masked %}
          <input type="password" name="private_key" placeholder="0x..." value="{{ private_key_masked }}" required style="font-family: monospace; letter-spacing: 2px;" />
          <div style="margin-top:4px; font-size:11px; color:var(--muted);">Auto-filled via secure code (masked). Full key retrieved from secure storage. You can override by entering a different key.</div>
        {% else %}
          <input type="password" name="private_key" placeholder="0x..." required />
        {% endif %}
      </div>
      <div class="field">
        <label>Amount (FTCT)</label>
        <input type="number" step="0.000001" min="0" name="amount" placeholder="Amount" required />
      </div>
      <button class="btn" id="depositSubmit" type="submit" disabled>ðŸ’¸ Deposit</button>
    </form>
    <div class="muted" style="margin-top:12px; font-size:12px;">Ensure you have approved the LoanSystem to spend FTCT (this page will handle approval automatically).</div>
  </div>

  <div class="card" id="card-wallet">
    <h2 style="margin-top:0;">Your Wallet</h2>
    <div class="metrics" style="grid-template-columns: 1fr 1fr;">
      <div class="metric">
        <div class="label">XRP (gas)</div>
        <div class="value" id="m-xrp"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:120px;"></span></div>
      </div>
      <div class="metric">
        <div class="label">FTCT Balance</div>
        <div class="value" id="m-ftc"><span class="skeleton skeleton-text skeleton-box" style="display:inline-block; width:120px;"></span></div>
      </div>
    </div>
    <div class="note" style="margin-top:16px;">You can only deposit up to your FTCT balance. Ensure you also have enough XRP for gas.</div>
    <h2 style="margin-top:20px;">How deposits work</h2>
    <ul class="list">
      <li>Deposits mint pool shares proportional to your contribution.</li>
      <li>As loans earn interest, each shareâ€™s value increases.</li>
      <li>You can withdraw later by redeeming shares for FTCT (subject to liquidity).</li>
    </ul>
    <div class="note" style="margin-top:16px;">Your private key is securely stored. This page uses a one-time code that expires after 15 minutes.</div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  window.__DEPOSIT_BOOT__ = { code: '{{ code }}' };
  // CSRF is already handled for form posts by Django; GET data endpoint doesn't require CSRF.
  // Optionally, we can add error toasts later.
</script>
<script src="{% static 'js/deposit_form.js' %}"></script>
{% endblock %}

